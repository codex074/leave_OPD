<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</title>
    <link rel="shortcut icon" href="sun.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap');
        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 50%, #4c1d95 100%);
            color: #333;
        }
        .container-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #6d28d9 0%, #4c1d95 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        .modern-table { width: 100%; border-collapse: collapse; }
        .modern-table th, .modern-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .modern-table th { background-color: #f9fafb; font-weight: 600; color: #4b5563; }
        .badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .badge-pharmacist { background-color: #e9d5ff; color: #7e22ce; } 
        .badge-officer { background-color: #e0e7ff; color: #3730a3; } 
        .badge-staff { background-color: #ffedd5; color: #9a3412; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-md mx-auto">
        <!-- Add User Form -->
        <div class="container-card">
            <div class="header">
                <h1 class="text-xl font-bold">üìã ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</h1>
                <p class="text-sm opacity-90">‡∏´‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å</p>
            </div>
            <div class="p-6">
                <form id="userForm" class="space-y-4">
                    <div>
                        <label for="userFullName" class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• <span class="text-red-500">*</span></label>
                        <input type="text" id="userFullName" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" required>
                    </div>
                    <div>
                        <label for="userNickname" class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô <span class="text-red-500">*</span></label>
                        <input type="text" id="userNickname" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" required>
                    </div>
                    <div>
                        <label for="userPosition" class="block text-sm font-medium text-gray-700 mb-1">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á <span class="text-red-500">*</span></label>
                        <select id="userPosition" class="w-full p-2 border border-gray-300 rounded-lg" required>
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>
                            <option value="‡πÄ‡∏†‡∏™‡∏±‡∏ä">‡πÄ‡∏†‡∏™‡∏±‡∏ä</option>
                            <option value="‡∏à‡∏û‡∏á">‡∏à‡∏û‡∏á</option>
                            <option value="‡∏à‡∏ô‡∏ó">‡∏à‡∏ô‡∏ó</option>
                        </select>
                    </div>
                    <div>
                        <button type="submit" class="w-full bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-6 rounded-lg transition-all">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Show User List Button -->
        <div class="mt-6 text-center">
            <button id="showUserListModalBtn" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-lg transition-all">üë• ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</button>
        </div>
    </div>

    <!-- User List Modal -->
    <div id="userListModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center p-4">
        <div class="container-card max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="header flex justify-between items-center">
                <h1 class="text-xl font-bold">üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</h1>
                <button id="closeUserListModal" class="text-white text-3xl hover:text-gray-200">&times;</button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto">
                <div class="flex justify-end items-center mb-4">
                    <select id="userPositionFilter" class="p-2 border border-gray-300 rounded-lg w-48"></select>
                </div>
                <div class="overflow-y-auto">
                    <table class="modern-table w-full">
                        <thead>
                            <tr>
                                <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th>
                                <th class="text-center">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                            </tr>
                        </thead>
                        <tbody id="userListTableBody"></tbody>
                    </table>
                </div>
                <div class="flex justify-center mt-4 space-x-2" id="userListPaginationControls"></div>
            </div>
        </div>
    </div>


     <!-- Footer -->
    <footer class="mt-16 text-center">
        <p class="text-gray-200 text-sm">¬© 2025 Register OPD - ‡∏†‡∏Å.‡∏ò‡∏µ‡∏£‡πÄ‡∏î‡∏ä ‡∏ß‡∏¥‡∏ä‡∏±‡∏¢ ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå</p>
    </footer>

    <script>
        // --- CONFIGURATION ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxuHOzS6xa_7Kwa0jrfNygfl8lh0nfIT5Z6wa5SSiWZcuACYF7tm87O51oSzXRQ8veT/exec'; // <-- URL ‡∏Ç‡∏≠‡∏á Web App ‡∏ó‡∏µ‡πà Deploy
        
        // --- GLOBAL VARIABLES ---
        let allUsers = [];
        let userCurrentPage = 1;
        const usersPerPage = 15;

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadInitialData();
        });

        // --- CORE FUNCTIONS ---
        async function apiCall(action, data, isSaveOperation = false) {
            const loadingTitle = isSaveOperation ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•';
            const loadingHtml = isSaveOperation ? '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            Swal.fire({ title: loadingTitle, html: loadingHtml, allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action, data })
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (!result.success) throw new Error(result.message || 'API call returned an error.');
                Swal.close();
                return result;
            } catch (error) {
                console.error(`API call failed for action: ${action}`, error);
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`, 'error');
                throw error;
            }
        }

        async function loadInitialData() {
            try {
                const data = await apiCall('loadData', {});
                allUsers = data.users || [];
                initializeFilters();
                updateUsersDisplay();
            } catch (error) {
                // Error is handled in apiCall
            }
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            document.getElementById('userForm').addEventListener('submit', handleUserFormSubmit);
            document.getElementById('userPositionFilter').addEventListener('change', updateUsersDisplay);
            setupModalListeners('userListModal', 'showUserListModalBtn', 'closeUserListModal');
        }

        // --- FORM HANDLER ---
        async function handleUserFormSubmit(e) {
            e.preventDefault();
            try {
                const nickname = document.getElementById('userNickname').value.trim();
                if (allUsers.some(u => u.nickname === nickname)) {
                    Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏°‡∏µ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'error');
                    return;
                }
                const user = {
                    fullName: document.getElementById('userFullName').value.trim(),
                    nickname: nickname,
                    position: document.getElementById('userPosition').value,
                    timestamp: new Date().toISOString()
                };
                await apiCall('saveUser', user, true);
                await Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                document.getElementById('userForm').reset();
                loadInitialData();
            } catch (error) {
                if (error && !error.message.includes('cancelled')) {
                    Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`, 'error');
                }
            }
        }

        // --- UI UPDATE FUNCTIONS ---
        function initializeFilters() {
            const userPositionFilter = document.getElementById('userPositionFilter');
            userPositionFilter.innerHTML = '<option value="">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
            const positions = [...new Set(allUsers.map(u => u.position))].sort((a, b) => a.localeCompare(b, 'th'));
            positions.forEach(pos => {
                userPositionFilter.add(new Option(pos, pos));
            });
        }

        function updateUsersDisplay() {
            const tbody = document.getElementById('userListTableBody');
            const positionFilter = document.getElementById('userPositionFilter').value;
            tbody.innerHTML = '';

            let filteredUsers = allUsers.filter(user => !positionFilter || user.position === positionFilter);
            const positionOrder = { '‡πÄ‡∏†‡∏™‡∏±‡∏ä': 1, '‡∏à‡∏û‡∏á': 2, '‡∏à‡∏ô‡∏ó': 3 };
            filteredUsers.sort((a, b) => {
                const posA = positionOrder[a.position] || 99;
                const posB = positionOrder[b.position] || 99;
                if (posA !== posB) return posA - posB;
                return a.nickname.localeCompare(b.nickname, 'th');
            });
            
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage) || 1;
            userCurrentPage = Math.min(userCurrentPage, totalPages) || 1;
            const pageUsers = filteredUsers.slice((userCurrentPage - 1) * usersPerPage, userCurrentPage * usersPerPage);

            pageUsers.forEach(user => {
                tbody.innerHTML += `
                    <tr>
                        <td>${user.fullName}</td>
                        <td>${user.nickname}</td>
                        <td class="text-center"><span class="badge ${getPositionBadgeClass(user.position)}">${user.position}</span></td>
                    </tr>
                `;
            });

            const paginationControls = document.getElementById('userListPaginationControls');
            paginationControls.innerHTML = `
                <button id="userPrevPage" class="bg-gray-200 text-gray-700 w-10 h-10 rounded-lg hover:bg-gray-300" ${userCurrentPage === 1 ? 'disabled' : ''}>&lt;</button>
                <span class="px-4 py-2 rounded-lg font-semibold">${userCurrentPage} / ${totalPages}</span>
                <button id="userNextPage" class="bg-gray-200 text-gray-700 w-10 h-10 rounded-lg hover:bg-gray-300" ${userCurrentPage === totalPages ? 'disabled' : ''}>&gt;</button>
            `;

            document.getElementById('userPrevPage').onclick = () => changeUserPage(-1, filteredUsers);
            document.getElementById('userNextPage').onclick = () => changeUserPage(1, filteredUsers);
        }

        function changeUserPage(direction, filteredUsers) {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage) || 1;
            const newPage = userCurrentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                userCurrentPage = newPage;
                updateUsersDisplay();
            }
        }
        
        // --- UTILITIES ---
        function setupModalListeners(modalId, openBtnId, closeBtnId, openCallback) {
            const modal = document.getElementById(modalId);
            const closeBtn = document.getElementById(closeBtnId);
            if (openBtnId) document.getElementById(openBtnId).addEventListener('click', openCallback || (() => openModal(modalId)));
            if (closeBtn) closeBtn.addEventListener('click', () => closeModal(modalId));
            if (modal) modal.addEventListener('click', (e) => e.target.id === modalId && closeModal(modalId));
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        const getPositionBadgeClass = (p) => ({'‡πÄ‡∏†‡∏™‡∏±‡∏ä':'badge-pharmacist','‡∏à‡∏û‡∏á':'badge-officer','‡∏à‡∏ô‡∏ó':'badge-staff'})[p]||'';

    </script>
</body>
</html>
